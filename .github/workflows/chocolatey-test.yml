name: chocolatey-test.yml
on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  chocolatey-test:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: TarasMazepa/github-action-cat@master
        id: get-dart-version
        with:
          path: DART_SDK_VERSION
          
      - uses: TarasMazepa/github-action-cat@master
        id: get-stax-version
        with:
          path: VERSION
          
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: ${{ steps.get-dart-version.outputs.text }}
      
      - name: Compile Stax binary
        working-directory: cli
        run: |
          dart pub get
          dart compile exe -o "../chocolatey/stax/tools/stax.exe" "-Dversion=${{ steps.get-stax-version.outputs.text }}" "bin/cli.dart"
          
      - name: Update version in nuspec file
        shell: pwsh
        run: |
          $nuspecPath = "chocolatey/stax/stax.nuspec"
          $xml = [xml](Get-Content $nuspecPath)
          $xml.package.metadata.version = "${{ steps.get-stax-version.outputs.text }}"
          $xml.Save($nuspecPath)
      
      - run: choco pack chocolatey/stax/stax.nuspec
      
      - run: choco install stax --source . -y
      - run: stax help
      - run: stax doctor
