on:
  workflow_dispatch:
    inputs:
      tag:
        required: true
        type: string
  release:
    types:
      - created

env:
  RELEASE: ${{ github.event.release.tag_name }}
  TAG: ${{ inputs.tag }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  CHECKOUT: $RELEASE$TAG

jobs:
  macos-arm:
    permissions: write-all
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: $CHECKOUT
      - uses: pCYSl5EDgo/cat@master
        id: get-dart-version
        with:
          path: DART_SDK_VERSION
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: ${{ steps.get-dart-version.outputs.text }}
      - run: dart pub get
        working-directory: cli
      - run: dart compile exe cli/bin/cli.dart -o cli/bin/stax
      - run: zip cli/bin/stax macos-arm.zip
      - run: gh release upload $RELEASE$TAG macos-arm.zip

  macos-x64:
    permissions: write-all
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
        with:
          ref: $CHECKOUT
      - uses: pCYSl5EDgo/cat@master
        id: get-dart-version
        with:
          path: DART_SDK_VERSION
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: ${{ steps.get-dart-version.outputs.text }}
      - run: dart pub get
        working-directory: cli
      - run: dart compile exe cli/bin/cli.dart -o cli/bin/stax
      - run: zip cli/bin/stax macos-x64.zip
      - run: gh release upload $RELEASE$TAG macos-x64.zip

  linux-x64:
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: $CHECKOUT
      - uses: pCYSl5EDgo/cat@master
        id: get-dart-version
        with:
          path: DART_SDK_VERSION
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: ${{ steps.get-dart-version.outputs.text }}
      - run: dart pub get
        working-directory: cli
      - run: dart compile exe cli/bin/cli.dart -o cli/bin/stax
      - run: zip cli/bin/stax linux-x64.zip
      - run: gh release upload $RELEASE$TAG linux-x64.zip

  windows-x64:
    permissions: write-all
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: $CHECKOUT
      - uses: pCYSl5EDgo/cat@master
        id: get-dart-version
        with:
          path: DART_SDK_VERSION
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: ${{ steps.get-dart-version.outputs.text }}
      - run: dart pub get
        working-directory: cli
      - run: dart compile exe cli/bin/cli.dart -o cli/bin/stax.exe
      - run: zip cli/bin/stax.exe windows-x64.zip
      - run: gh release upload $RELEASE$TAG windows-x64.zip
